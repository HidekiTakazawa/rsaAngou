<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RSAæš—å·å­¦ç¿’ã‚¢ãƒ—ãƒª</title>
    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo 600 */
            --primary-color-dark: #4338ca; /* Indigo 700 */
            --secondary-color: #64748b; /* Slate 500 */
            --bg-color: #f1f5f9; /* Slate 100 */
            --text-color: #0f172a; /* Slate 900 */
            --subtle-text-color: #475569; /* Slate 600 */
            --border-color: #e2e8f0; /* Slate 200 */
            --card-bg: #ffffff;
            --code-bg: #eef2ff; /* Indigo 50 */
            --code-text: #312e81; /* Indigo 900 */
            --code-border: #c7d2fe; /* Indigo 200 */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --input-bg: #f8fafc; /* Slate 50 */
            --focus-shadow: rgba(79, 70, 229, 0.1);
            --spinner-track: rgba(0,0,0,0.1);
        }
        [data-theme="dark"] {
            --primary-color: #6366f1; /* Indigo 500 */
            --primary-color-dark: #4f46e5; /* Indigo 600 */
            --secondary-color: #94a3b8; /* Slate 400 */
            --bg-color: #0f172a; /* Slate 900 */
            --text-color: #f1f5f9; /* Slate 100 */
            --subtle-text-color: #94a3b8; /* Slate 400 */
            --border-color: #334155; /* Slate 700 */
            --card-bg: #1e293b; /* Slate 800 */
            --code-bg: #334155; /* Slate 700 */
            --code-text: #e2e8f0; /* Slate 200 */
            --code-border: #475569; /* Slate 600 */
            --input-bg: #1e293b; /* Slate 800 */
            --focus-shadow: rgba(99, 102, 241, 0.2);
            --spinner-track: rgba(255,255,255,0.1);
        }
        /* ã‚¹ãƒ”ãƒŠãƒ¼ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .spinner { border: 4px solid var(--spinner-track); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", "Inter", sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px 40px;
            position: relative;
        }
        header {
            background-color: transparent;
            color: var(--text-color);
            padding: 2.5rem 1rem;
            text-align: center;
        }
        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }
        nav {
            background-color: transparent;
            border-bottom: 1px solid var(--border-color);
            margin-top: 0;
            padding: 0 10px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        nav a {
            color: var(--subtle-text-color);
            text-decoration: none;
            padding: 12px 16px;
            border-radius: 0;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px; /* To align with the nav border */
        }
        nav a:hover {
            background-color: transparent;
            color: var(--primary-color);
        }
        nav a.active {
            background-color: transparent;
            color: var(--primary-color);
            font-weight: 600;
            border-bottom-color: var(--primary-color);
        }
        main section {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background-color: var(--card-bg);
            border: none;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        main section.active {
            display: block;
        }
        h2 {
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            font-size: 1.5rem;
            font-weight: 600;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--subtle-text-color);
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-family: 'Fira Code', 'Source Code Pro', monospace;
            background-color: var(--input-bg);
        color: var(--text-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--focus-shadow);
        }
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            box-shadow: var(--shadow-sm);
        }
        button:hover {
            background-color: var(--primary-color-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        button.secondary {
            background-color: var(--secondary-color);
        }
        button.secondary:hover {
            background-color: #475569; /* Slate 600 */
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        #theme-toggle {
            position: absolute;
            top: 2.5rem;
            right: 20px;
            background: none;
            border: 1px solid var(--border-color);
            color: var(--subtle-text-color);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #theme-toggle:hover {
            background-color: var(--code-bg);
            color: var(--text-color);
            transform: none; /* override generic button hover */
            box-shadow: none;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--code-bg);
            border: 1px solid var(--code-border);
            border-radius: 6px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Fira Code', 'Source Code Pro', monospace;
            color: var(--code-text);
            line-height: 1.5;
        }
        .description {
            background-color: var(--input-bg);
            padding: 15px;
            border-radius: 5px;
            margin-top: 25px;
            border-left: 4px solid var(--border-color);
        }
        fieldset {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        legend {
            padding: 0 10px;
            font-weight: 600;
            color: var(--text-color);
        }
    </style>
</head>
<body>

    <div class="container">
        <button id="theme-toggle" title="ãƒ†ãƒ¼ãƒã‚’åˆ‡ã‚Šæ›¿ãˆ">ğŸŒ™</button>
        <header>
            <h1>RSAæš—å·å­¦ç¿’ã‚¢ãƒ—ãƒª</h1>
        </header>

        <nav id="nav-menu">
            <a href="#menu" data-section="menu" class="active">ãƒ›ãƒ¼ãƒ </a>
            <a href="#extgcd" data-section="extgcd">æ‹¡å¼µãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰äº’é™¤æ³•</a>
            <a href="#expmod" data-section="expmod">ç¹°ã‚Šè¿”ã—äºŒä¹—æ³•</a>
            <a href="#keygen" data-section="keygen">ã‚­ãƒ¼ãƒšã‚¢ä½œæˆ</a>
            <a href="#encrypt" data-section="encrypt">æš—å·åŒ–</a>
            <a href="#decrypt" data-section="decrypt">å¾©å·</a>
            <a href="#create-signed-message" data-section="create-signed-message">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ(ç½²åä»˜)</a>
            <a href="#read-signed-message" data-section="read-signed-message">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¾©å·(ç½²åæ¤œè¨¼)</a>
            <a href="#prime-list" data-section="prime-list">ä»˜éŒ²: ç´ æ•°ä¸€è¦§</a>
        </nav>

        <main>
            <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
            <section id="menu">
                <h2>ã‚ˆã†ã“ãï¼</h2>
                <p>ã“ã®ã‚¢ãƒ—ãƒªã¯ã€å…¬é–‹éµæš—å·æ–¹å¼ã®ä»£è¡¨ã§ã‚ã‚‹RSAæš—å·ã®ä»•çµ„ã¿ã‚’å­¦ã¶ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚</p>
                <p>ä¸Šã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰å„æ©Ÿèƒ½ã‚’ä½“é¨“ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</p>
                <ol>
                    <li><b>æ‹¡å¼µãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰äº’é™¤æ³•</b>: RSAã®ã‚­ãƒ¼ãƒšã‚¢ä½œæˆã«ä½¿ã‚ã‚Œã‚‹æ•°å­¦çš„ãªé“å…·ã§ã™ã€‚</li>
                    <li><b>ç¹°ã‚Šè¿”ã—äºŒä¹—æ³•</b>: æš—å·åŒ–ãƒ»å¾©å·ã®éš›ã®å·¨å¤§ãªã¹ãä¹—è¨ˆç®—ã‚’é«˜é€Ÿã«è¡Œã†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã™ã€‚</li>
                    <li><b>ã‚­ãƒ¼ãƒšã‚¢ä½œæˆ</b>: 2ã¤ã®ç´ æ•°ã‹ã‚‰ã€æš—å·åŒ–ã«ä½¿ã†ã€Œå…¬é–‹éµã€ã¨å¾©å·ã«ä½¿ã†ã€Œç§˜å¯†éµã€ã®ãƒšã‚¢ã‚’ä½œæˆã—ã¾ã™ã€‚</li>
                    <li><b>æš—å·åŒ–</b>: å¹³æ–‡ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ã‚’å…¬é–‹éµã§æš—å·åŒ–ã—ã¾ã™ã€‚</li>
                    <li><b>å¾©å·</b>: æš—å·æ–‡ã‚’ç§˜å¯†éµã§å…ƒã®å¹³æ–‡ã«æˆ»ã—ã¾ã™ã€‚</li>
                    <li><b>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ(ç½²åä»˜)</b>: é€ä¿¡è€…ã®ç§˜å¯†éµã§ã€Œç½²åã€ã—ã€å—ä¿¡è€…ã®å…¬é–‹éµã§ã€Œæš—å·åŒ–ã€ã™ã‚‹ã“ã¨ã§ã€å®‰å…¨ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¾ã™ã€‚</li>
                    <li><b>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¾©å·(ç½²åæ¤œè¨¼)</b>: å—ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã€ã¾ãšå—ä¿¡è€…ã®ç§˜å¯†éµã§ã€Œå¾©å·ã€ã—ã€æ¬¡ã«é€ä¿¡è€…ã®å…¬é–‹éµã§ã€Œç½²åã‚’æ¤œè¨¼ã€ã—ã¦å…ƒã®å†…å®¹ã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚</li>
                    <li><b>ä»˜éŒ²: ç´ æ•°ä¸€è¦§</b>: ã‚­ãƒ¼ãƒšã‚¢ä½œæˆã«ä½¿ãˆã‚‹å¤§ããªç´ æ•°ã®ãƒªã‚¹ãƒˆã§ã™ã€‚ã“ã“ã‹ã‚‰å¥½ããªç´ æ•°ã‚’é¸ã‚“ã§è©¦ã›ã¾ã™ã€‚</li>
                </ol>
                <div class="description">
                    <h3>RSAæš—å·ã®ä»•çµ„ã¿</h3>
                    <p>RSAæš—å·ã®åŸç†ã¯ã€å¤ä»£ã‚®ãƒªã‚·ãƒ£ã®æ•°å­¦è€…ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰ã‚„ã€17ä¸–ç´€ã®æ•°å­¦è€…ãƒ•ã‚§ãƒ«ãƒãƒ¼ã€18ä¸–ç´€ã®æ•°å­¦è€…ã‚ªã‚¤ãƒ©ãƒ¼ã®æ¥­ç¸¾ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ã€Œãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰ã®äº’é™¤æ³•ã€ã‚„ã€ãƒ•ã‚§ãƒ«ãƒãƒ¼ã®å°å®šç†ã‚’ä¸€èˆ¬åŒ–ã—ãŸã€Œã‚ªã‚¤ãƒ©ãƒ¼ã®å®šç†ã€ã¨ã„ã†æ•°è«–ã®å®šç†ãŒä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚</p>
                    <ol>
                        <li>
                            <strong>å·¨å¤§ãªç´ æ•° p, q ã‚’ç”¨æ„ã™ã‚‹</strong><br>
                            ã¾ãšã€éå¸¸ã«å¤§ããªç´ æ•°ã‚’2ã¤ï¼ˆp ã¨ qï¼‰ç”¨æ„ã—ã€ã“ã‚Œã‚‰ã¯ç§˜å¯†ã«ã—ã¾ã™ã€‚
                        </li>
                        <li>
                            <strong>å…¬é–‹éµ {e, n} ã‚’è¨ˆç®—ã™ã‚‹</strong><br>
                            p ã¨ q ã®ç© <code>n = p * q</code> ã‚’è¨ˆç®—ã—ã¾ã™ã€‚ã“ã® <code>n</code> ã¯å…¬é–‹éµã®ä¸€éƒ¨ã¨ãªã‚Šã¾ã™ã€‚<code>n</code> ã‹ã‚‰å…ƒã® p ã¨ q ã‚’è¦‹ã¤ã‘å‡ºã™ã“ã¨ï¼ˆç´ å› æ•°åˆ†è§£ï¼‰ãŒã€ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ã‚‚éå¸¸ã«å›°é›£ã§ã‚ã‚‹ã“ã¨ãŒã€RSAæš—å·ã®å®‰å…¨æ€§ã®æ ¹æ‹ ã§ã™ã€‚<br>
                            æ¬¡ã«ã€<code>Ï†(n) = (p-1) * (q-1)</code> ã¨äº’ã„ã«ç´ ï¼ˆæœ€å¤§å…¬ç´„æ•°ãŒ1ï¼‰ã¨ãªã‚‹æ•° <code>e</code> ã‚’é¸ã³ã¾ã™ã€‚ã“ã® <code>e</code> ã‚‚å…¬é–‹éµã®ä¸€éƒ¨ã§ã™ã€‚ã“ã‚Œã§ã€èª°ã§ã‚‚ä½¿ãˆã‚‹**å…¬é–‹éµ {e, n}** ãŒå®Œæˆã—ã¾ã™ã€‚
                        </li>
                        <li>
                            <strong>ç§˜å¯†éµ {d, n} ã‚’è¨ˆç®—ã™ã‚‹</strong><br>
                            <code>e * d</code> ã‚’ <code>Ï†(n)</code> ã§å‰²ã£ãŸä½™ã‚ŠãŒ1ã¨ãªã‚‹æ•° <code>d</code> ã‚’è¨ˆç®—ã—ã¾ã™ï¼ˆ<code>e*d â‰¡ 1 (mod Ï†(n))</code>ï¼‰ã€‚ã“ã®è¨ˆç®—ã«ã¯æ‹¡å¼µãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰äº’é™¤æ³•ãŒä½¿ã‚ã‚Œã¾ã™ã€‚ã“ã†ã—ã¦è¦‹ã¤ã‹ã£ãŸ <code>d</code> ãŒã€è‡ªåˆ†ã ã‘ãŒçŸ¥ã£ã¦ã„ã‚‹**ç§˜å¯†éµ**ã¨ãªã‚Šã¾ã™ã€‚
                        </li>
                        <li>
                            <strong>æš—å·åŒ–ã¨å¾©å·</strong><br>
                            å¹³æ–‡ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ã‚’æ•°å€¤ <code>m</code> ã¨ã—ãŸã¨ãã€ä»¥ä¸‹ã®è¨ˆç®—ã§æš—å·åŒ–ã¨å¾©å·ãŒè¡Œãˆã¾ã™ã€‚<br>
                            <b>æš—å·åŒ–</b>: <code>c = m<sup>e</sup> mod n</code> ï¼ˆå…¬é–‹éµ <code>e</code> ã§æš—å·åŒ–ã—ã€æš—å·æ–‡ <code>c</code> ã‚’ä½œã‚‹ï¼‰<br>
                            <b>å¾©å·</b>: <code>m = c<sup>d</sup> mod n</code> ï¼ˆç§˜å¯†éµ <code>d</code> ã§å¾©å·ã—ã€å…ƒã®å¹³æ–‡ <code>m</code> ã«æˆ»ã™ï¼‰<br>
                            ã“ã®é–¢ä¿‚ãŒæˆã‚Šç«‹ã¤ã®ã¯ã€<code>m<sup>e*d</sup> â‰¡ m (mod n)</code> ã¨ã„ã†ã‚ªã‚¤ãƒ©ãƒ¼ã®å®šç†ã‹ã‚‰å°ã‹ã‚Œã‚‹æ€§è³ªã®ãŠã‹ã’ã§ã™ã€‚
                        </li>
                        <li>
                            <strong>eã¨dã®å½¹å‰²ã®äº¤æ›</strong><br>
                            ä¸Šè¨˜ã®æš—å·åŒ–ãƒ»å¾©å·ã®è¨ˆç®—ã«ãŠã„ã¦ã€<code>e</code> ã¨ <code>d</code> ã®å½¹å‰²ã‚’å…¥ã‚Œæ›¿ãˆã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚ã“ã®æ€§è³ªãŒã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡è€…ãŒæœ¬äººã§ã‚ã‚‹ã“ã¨ã‚’è¨¼æ˜ã™ã‚‹ã€Œãƒ‡ã‚¸ã‚¿ãƒ«ç½²åã€ã«å¿œç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
                        </li>
                    </ol>
                    </div>
                <div class="description">
                    <h3>å…¬é–‹éµæš—å·æ–¹å¼ã«ã‚ˆã‚‹å®‰å…¨ãªé€šä¿¡ï¼ˆãƒ‡ã‚¸ã‚¿ãƒ«ç½²åä»˜ãï¼‰</h3>
                    <p>ã“ã®ã‚¢ãƒ—ãƒªã§ã¯ã€ãƒ‡ã‚¸ã‚¿ãƒ«ç½²åã‚’ä»˜ä¸ã—ãŸæš—å·åŒ–é€šä¿¡ã‚’ä½“é¨“ã§ãã¾ã™ã€‚ã“ã‚Œã¯ã€é€ä¿¡è€…ãŒæœ¬äººã§ã‚ã‚‹ã“ã¨ï¼ˆèªè¨¼ï¼‰ã¨ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ”¹ã–ã‚“ã•ã‚Œã¦ã„ãªã„ã“ã¨ï¼ˆå®Œå…¨æ€§ï¼‰ã‚’ä¿è¨¼ã—ã¤ã¤ã€ç¬¬ä¸‰è€…ã«ã¯å†…å®¹ã‚’èª­ã¾ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ï¼ˆæ©Ÿå¯†æ€§ï¼‰ãŸã‚ã®ä»•çµ„ã¿ã§ã™ã€‚</p>
                    <ol>
                        <li>å„å€‹äººã¯ã€è‡ªåˆ†ã ã‘ã®ã€Œç§˜å¯†éµã€ã¨ã€ã¿ã‚“ãªã«å…¬é–‹ã™ã‚‹ã€Œå…¬é–‹éµã€ã®ãƒšã‚¢ã‚’æŒã¡ã¾ã™ã€‚</li>
                        <li>é€ä¿¡è€…ã¯ã€ã¾ãšé€ã‚ŠãŸã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå¹³æ–‡ï¼‰ã‚’<b>é€ä¿¡è€…ã®ç§˜å¯†éµ</b>ã§æš—å·åŒ–ã—ã¾ã™ã€‚ã“ã‚ŒãŒã€Œãƒ‡ã‚¸ã‚¿ãƒ«ç½²åã€ã«ãªã‚Šã¾ã™ã€‚</li>
                        <li>æ¬¡ã«ã€ç½²åã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’<b>å—ä¿¡è€…ã®å…¬é–‹éµ</b>ã§æš—å·åŒ–ã—ã¾ã™ã€‚ã“ã‚Œã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†…å®¹ãŒä¿è­·ã•ã‚Œã¾ã™ã€‚</li>
                        <li>å—ä¿¡è€…ã¯ã€å—ã‘å–ã£ãŸæš—å·æ–‡ã‚’ã¾ãš<b>å—ä¿¡è€…ã®ç§˜å¯†éµ</b>ã§å¾©å·ã—ã¾ã™ã€‚</li>
                        <li>æœ€å¾Œã«ã€å‡ºã¦ããŸãƒ‡ãƒ¼ã‚¿ã‚’<b>é€ä¿¡è€…ã®å…¬é–‹éµ</b>ã§å¾©å·ï¼ˆç½²åæ¤œè¨¼ï¼‰ã—ã¾ã™ã€‚ã“ã‚Œã§å…ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ‰‹ã«å…¥ã‚Šã¾ã™ã€‚</li>
                    </ol>
                </div>
            </section>

            <!-- æ‹¡å¼µãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰äº’é™¤æ³• -->
            <section id="extgcd">
                <h2>æ‹¡å¼µãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰äº’é™¤æ³• ä½“é¨“</h2>
                <div class="input-group">
                    <label for="extgcd-a">æ•´æ•° a:</label>
                    <input type="text" id="extgcd-a" placeholder="ä¾‹: 240">
                </div>
                <div class="input-group">
                    <label for="extgcd-b">æ•´æ•° b:</label>
                    <input type="text" id="extgcd-b" placeholder="ä¾‹: 46">
                </div>
                <button id="run-extgcd">è¨ˆç®—å®Ÿè¡Œ</button>
                <div id="extgcd-result" class="result"></div>
                <div class="description">
                    <h3>ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ èª¬æ˜</h3>
                    <p>æ‹¡å¼µãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰ã®äº’é™¤æ³•ã¯ã€äºŒå…ƒä¸€æ¬¡ä¸å®šæ–¹ç¨‹å¼ <b>ax + by = gcd(a, b)</b> ã‚’æº€ãŸã™æ•´æ•°è§£ (x, y) ã¨ã€aã¨bã®æœ€å¤§å…¬ç´„æ•° d (gcd) ã‚’è¦‹ã¤ã‘ã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã™ã€‚</p>
                    <p>RSAæš—å·ã§ã¯ã€ç§˜å¯†éµã‚’è¨ˆç®—ã™ã‚‹éš›ã«ã“ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒä½¿ã‚ã‚Œã¾ã™ã€‚</p>
                </div>
            </section>

            <!-- ç¹°ã‚Šè¿”ã—äºŒä¹—æ³• -->
            <section id="expmod">
                <h2>ç¹°ã‚Šè¿”ã—äºŒä¹—æ³• ä½“é¨“</h2>
                <div class="input-group">
                    <label for="expmod-a">åŸºæ•° a (a^n):</label>
                    <input type="text" id="expmod-a" placeholder="ä¾‹: 3">
                </div>
                <div class="input-group">
                    <label for="expmod-n">æŒ‡æ•° n (a^n):</label>
                    <input type="text" id="expmod-n" placeholder="ä¾‹: 100">
                </div>
                <div class="input-group">
                    <label for="expmod-p">æ³• p (mod p):</label>
                    <input type="text" id="expmod-p" placeholder="ä¾‹: 101">
                </div>
                <button id="run-expmod">è¨ˆç®—å®Ÿè¡Œ</button>
                <div id="expmod-result" class="result"></div>
                <div class="description">
                    <h3>ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ èª¬æ˜</h3>
                    <p>ç¹°ã‚Šè¿”ã—äºŒä¹—æ³•ã¯ã€<b>a<sup>n</sup> mod p</b> ã®ã‚ˆã†ãªã€éå¸¸ã«å¤§ããªæ•°ã®ã¹ãä¹—ã¨ãã®å‰°ä½™ã‚’åŠ¹ç‡çš„ã«è¨ˆç®—ã™ã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§ã™ã€‚</p>
                    <p>ä¾‹ãˆã°ã€3<sup>100</sup> ã®ã‚ˆã†ãªå¤©æ–‡å­¦çš„ãªæ•°ã§ã‚‚ã€ã“ã®æ–¹æ³•ã‚’ä½¿ãˆã°ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã§ç¬æ™‚ã«è¨ˆç®—ã§ãã¾ã™ã€‚RSAã®æš—å·åŒ–ãƒ»å¾©å·å‡¦ç†ã®æ ¸ã¨ãªã‚‹è¨ˆç®—ã§ã™ã€‚</p>
                </div>
            </section>

            <!-- ã‚­ãƒ¼ãƒšã‚¢ä½œæˆ -->
            <section id="keygen">
                <h2>å…¬é–‹éµã¨ç§˜å¯†éµã®ä½œæˆ</h2>
                <div class="input-group">
                    <label for="keygen-p">ç´ æ•° p:</label>
                    <input type="text" id="keygen-p" placeholder="ä¾‹: 90011 (ç´ æ•°ä¸€è¦§ã‹ã‚‰é¸æŠ)">
                </div>
                <div class="input-group">
                    <label for="keygen-q">ç´ æ•° q:</label>
                    <input type="text" id="keygen-q" placeholder="ä¾‹: 90017 (pã¨ã¯ç•°ãªã‚‹ç´ æ•°)">
                </div>
                <div class="input-group">
                    <label for="keygen-e">å…¬é–‹æŒ‡æ•° e ( (p-1)(q-1)ã¨äº’ã„ã«ç´ ãªæ•° ):</label>
                    <input type="text" id="keygen-e" placeholder="ä¾‹: 65537 (ä¸€èˆ¬çš„ã«ã‚ˆãä½¿ã‚ã‚Œã‚‹å€¤)">
                </div>
                <div class="button-group">
                    <button id="set-random-primes" class="secondary">ãƒ©ãƒ³ãƒ€ãƒ ãªç´ æ•°ã‚’ã‚»ãƒƒãƒˆ</button>
                    <button id="run-keygen">ã‚­ãƒ¼ãƒšã‚¢ä½œæˆ</button>
                </div>
                <div id="keygen-result" class="result"></div>
            </section>

            <!-- æš—å·åŒ– -->
            <section id="encrypt">
                <h2>æš—å·åŒ– (å…¬é–‹éµã‚’ä½¿ç”¨)</h2>
                <div class="input-group">
                    <label for="encrypt-m">å¹³æ–‡ M (æ•°å€¤):</label>
                    <textarea id="encrypt-m" rows="3" placeholder="ä¾‹: 65 (æ³•nã‚ˆã‚Šå°ã•ã„æ•°å€¤)"></textarea>
                </div>
                <div class="input-group">
                    <label for="encrypt-e">å…¬é–‹æŒ‡æ•° e:</label>
                    <textarea id="encrypt-e" rows="3" placeholder="ã‚­ãƒ¼ãƒšã‚¢ä½œæˆã§ç”Ÿæˆã•ã‚ŒãŸå…¬é–‹æŒ‡æ•°e"></textarea>
                </div>
                <div class="input-group">
                    <label for="encrypt-n">æ³• n:</label>
                    <textarea id="encrypt-n" rows="3" placeholder="ã‚­ãƒ¼ãƒšã‚¢ä½œæˆã§ç”Ÿæˆã•ã‚ŒãŸæ³•n"></textarea>
                </div>
                <button id="run-encrypt">æš—å·åŒ–å®Ÿè¡Œ</button>
                <div id="encrypt-result" class="result"></div>
            </section>

            <!-- å¾©å· -->
            <section id="decrypt">
                <h2>å¾©å· (ç§˜å¯†éµã‚’ä½¿ç”¨)</h2>
                <div class="input-group">
                    <label for="decrypt-c">æš—å·æ–‡ C:</label>
                    <textarea id="decrypt-c" rows="3" placeholder="æš—å·åŒ–ã§ç”Ÿæˆã•ã‚ŒãŸæš—å·æ–‡C"></textarea>
                </div>
                <div class="input-group">
                    <label for="decrypt-d">ç§˜å¯†æŒ‡æ•° d:</label>
                    <textarea id="decrypt-d" rows="3" placeholder="ã‚­ãƒ¼ãƒšã‚¢ä½œæˆã§ç”Ÿæˆã•ã‚ŒãŸç§˜å¯†æŒ‡æ•°d"></textarea>
                </div>
                <div class="input-group">
                    <label for="decrypt-n">æ³• n:</label>
                    <textarea id="decrypt-n" rows="3" placeholder="ã‚­ãƒ¼ãƒšã‚¢ä½œæˆã§ç”Ÿæˆã•ã‚ŒãŸæ³•n"></textarea>
                </div>
                <button id="run-decrypt">å¾©å·å®Ÿè¡Œ</button>
                <div id="decrypt-result" class="result"></div>
            </section>

            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆï¼ˆç½²åã¨æš—å·åŒ–ï¼‰ -->
            <section id="create-signed-message">
                <h2>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆï¼ˆç½²åã¨æš—å·åŒ–ï¼‰</h2>
                <p>æ¼¢å­—ã‚„çµµæ–‡å­—ã‚’å«ã‚€æ–‡ç« ã‚’ã€æŒ‡å®šã—ãŸã‚­ãƒ¼ã§ç½²åãƒ»æš—å·åŒ–ã—ã¾ã™ã€‚</p>
                <div class="input-group">
                    <label for="create-message-text">é€ä¿¡ã—ãŸã„æ–‡ç« ï¼ˆå¹³æ–‡ï¼‰:</label>
                    <textarea id="create-message-text" rows="4">ã“ã‚Œã¯ç§˜å¯†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™ã€‚
ã“ã‚“ã«ã¡ã¯ã€ä¸–ç•Œï¼
Hello, World! ğŸ‘‹</textarea>
                </div>

                <fieldset>
                    <legend><strong>é€ä¿¡è€… (A) ã®ã‚­ãƒ¼</strong> (ã“ã‚Œã§ç½²å)</legend>
                    <div class="input-group"><label for="create-p-a">ç´ æ•° p:</label><input type="text" id="create-p-a" placeholder="é€ä¿¡è€…Aã®ç´ æ•°p"></div>
                    <div class="input-group"><label for="create-q-a">ç´ æ•° q:</label><input type="text" id="create-q-a" placeholder="é€ä¿¡è€…Aã®ç´ æ•°q"></div>
                    <div class="input-group"><label for="create-e-a">å…¬é–‹æŒ‡æ•° e:</label><input type="text" id="create-e-a" placeholder="é€ä¿¡è€…Aã®å…¬é–‹æŒ‡æ•°e"></div>
                </fieldset>

                <fieldset>
                    <legend><strong>å—ä¿¡è€… (B) ã®å…¬é–‹éµ</strong> (ã“ã‚Œã§æš—å·åŒ–)</legend>
                    <div class="input-group"><label for="create-n-b">æ³• n:</label><input type="text" id="create-n-b" placeholder="å—ä¿¡è€…Bã®æ³•n"></div>
                    <div class="input-group"><label for="create-e-b">å…¬é–‹æŒ‡æ•° e:</label><input type="text" id="create-e-b" placeholder="å—ä¿¡è€…Bã®å…¬é–‹æŒ‡æ•°e"></div>
                </fieldset>

                <button id="run-create-message">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆå®Ÿè¡Œ</button>
                <div class="spinner" id="create-spinner"></div>
                <div id="create-message-result" class="result"></div>
            </section>

            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¾©å·ï¼ˆå¾©å·ã¨ç½²åæ¤œè¨¼ï¼‰ -->
            <section id="read-signed-message">
                <h2>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¾©å·ï¼ˆå¾©å·ã¨ç½²åæ¤œè¨¼ï¼‰</h2>
                <p>ç½²åãƒ»æš—å·åŒ–ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…ƒã®æ–‡ç« ã«æˆ»ã—ã¾ã™ã€‚</p>
                <div class="input-group">
                    <label for="read-ciphertext">å—ä¿¡ã—ãŸæš—å·æ–‡ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰:</label>
                    <textarea id="read-ciphertext" rows="6" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆã§ç”Ÿæˆã•ã‚ŒãŸã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®æš—å·æ–‡"></textarea>
                </div>

                <fieldset>
                    <legend><strong>å—ä¿¡è€… (B) ã®ã‚­ãƒ¼</strong> (ã“ã‚Œã§å¾©å·)</legend>
                    <div class="input-group"><label for="read-p-b">ç´ æ•° p:</label><input type="text" id="read-p-b" placeholder="å—ä¿¡è€…Bã®ç´ æ•°p"></div>
                    <div class="input-group"><label for="read-q-b">ç´ æ•° q:</label><input type="text" id="read-q-b" placeholder="å—ä¿¡è€…Bã®ç´ æ•°q"></div>
                    <div class="input-group"><label for="read-e-b">å…¬é–‹æŒ‡æ•° e:</label><input type="text" id="read-e-b" placeholder="å—ä¿¡è€…Bã®å…¬é–‹æŒ‡æ•°e"></div>
                </fieldset>

                <fieldset>
                    <legend><strong>é€ä¿¡è€… (A) ã®å…¬é–‹éµ</strong> (ã“ã‚Œã§ç½²åæ¤œè¨¼)</legend>
                    <div class="input-group"><label for="read-n-a">æ³• n:</label><input type="text" id="read-n-a" placeholder="é€ä¿¡è€…Aã®æ³•n"></div>
                    <div class="input-group"><label for="read-e-a">å…¬é–‹æŒ‡æ•° e:</label><input type="text" id="read-e-a" placeholder="é€ä¿¡è€…Aã®å…¬é–‹æŒ‡æ•°e"></div>
                </fieldset>

                <button id="run-read-message">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¾©å·å®Ÿè¡Œ</button>
                <div class="spinner" id="read-spinner"></div>
                <div id="read-message-result" class="result"></div>
            </section>
            <!-- ä»˜éŒ²: ç´ æ•°ä¸€è¦§ -->
            <section id="prime-list">
                <h2>ä»˜éŒ²: 90000ã‹ã‚‰99999ã¾ã§ã®ç´ æ•°ä¸€è¦§</h2>
                <p>ã‚­ãƒ¼ãƒšã‚¢ä½œæˆæ™‚ã«ä½¿ç”¨ã§ãã‚‹ç´ æ•°ã®ä¾‹ã§ã™ã€‚ã“ã“ã‹ã‚‰2ã¤é¸ã‚“ã§ã€Œã‚­ãƒ¼ãƒšã‚¢ä½œæˆã€ç”»é¢ã®pã¨qã«å…¥åŠ›ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</p>
                <div class="result">
90001, 90007, 90011, 90017, 90019, 90023, 90031, 90053, 90059, 90067, 90071, 90073, 90089, 90107, 90121, 90127, 90149, 90163, 90173, 90187, 90191, 90197, 90199, 90203, 90217, 90227, 90239, 90247, 90263, 90271, 90281, 90289, 90313, 90353, 90359, 90371, 90373, 90379, 90397, 90401, 90403, 90407, 90437, 90439, 90469, 90473, 90481, 90499, 90511, 90523, 90527, 90529, 90533, 90547, 90583, 90599, 90617, 90619, 90631, 90641, 90647, 90659, 90677, 90679, 90697, 90703, 90709, 90731, 90749, 90787, 90793, 90803, 90821, 90823, 90833, 90841, 90847, 90863, 90887, 90901, 90907, 90911, 90917, 90931, 90947, 90971, 90977, 90989, 90997, 91009, 91019, 91033, 91079, 91081, 91097, 91099, 91121, 91127, 91129, 91139, 91141, 91151, 91153, 91159, 91163, 91183, 91193, 91199, 91229, 91237, 91243, 91249, 91253, 91283, 91291, 91297, 91303, 91309, 91331, 91367, 91369, 91373, 91381, 91387, 91393, 91397, 91411, 91423, 91433, 91453, 91457, 91459, 91463, 91493, 91499, 91513, 91529, 91541, 91571, 91573, 91577, 91583, 91591, 91621, 91631, 91639, 91673, 91691, 91703, 91711, 91733, 91753, 91757, 91771, 91781, 91801, 91807, 91811, 91813, 91823, 91837, 91841, 91867, 91873, 91909, 91921, 91939, 91943, 91951, 91957, 91961, 91967, 91969, 91997, 92003, 92009, 92033, 92041, 92051, 92077, 92083, 92107, 92111, 92119, 92143, 92153, 92173, 92177, 92179, 92189, 92203, 92219, 92221, 92227, 92233, 92237, 92243, 92251, 92269, 92297, 92311, 92317, 92333, 92347, 92353, 92357, 92363, 92369, 92377, 92381, 92383, 92387, 92399, 92401, 92413, 92419, 92431, 92459, 92461, 92467, 92479, 92489, 92503, 92507, 92551, 92557, 92567, 92569, 92581, 92593, 92623, 92627, 92639, 92641, 92647, 92657, 92669, 92671, 92681, 92683, 92693, 92699, 92707, 92717, 92723, 92737, 92753, 92761, 92767, 92779, 92789, 92791, 92801, 92809, 92821, 92831, 92849, 92857, 92861, 92863, 92867, 92893, 92899, 92921, 92927, 92941, 92951, 92957, 92959, 92987, 92993, 93001, 93047, 93053, 93059, 93077, 93083, 93089, 93097, 93103, 93113, 93131, 93133, 93139, 93151, 93169, 93179, 93187, 93199, 93229, 93239, 93241, 93251, 93253, 93257, 93263, 93281, 93283, 93287, 93307, 93319, 93323, 93329, 93337, 93371, 93377, 93383, 93407, 93419, 93427, 93463, 93479, 93481, 93487, 93491, 93493, 93497, 93503, 93523, 93529, 93553, 93557, 93559, 93563, 93581, 93601, 93607, 93629, 93637, 93683, 93701, 93703, 93719, 93739, 93761, 93763, 93787, 93809, 93811, 93827, 93851, 93871, 93887, 93889, 93893, 93901, 93911, 93913, 93923, 93937, 93941, 93949, 93967, 93971, 93979, 93983, 93997, 94007, 94009, 94033, 94049, 94057, 94063, 94079, 94099, 94109, 94111, 94117, 94121, 94151, 94153, 94169, 94201, 94207, 94219, 94229, 94253, 94261, 94273, 94291, 94307, 94309, 94321, 94327, 94331, 94343, 94349, 94351, 94379, 94397, 94399, 94421, 94427, 94433, 94439, 94441, 94447, 94463, 94477, 94483, 94513, 94529, 94531, 94541, 94543, 94547, 94559, 94561, 94573, 94583, 94597, 94603, 94613, 94621, 94649, 94651, 94687, 94693, 94709, 94723, 94727, 94747, 94771, 94777, 94781, 94789, 94793, 94811, 94819, 94823, 94837, 94841, 94847, 94849, 94873, 94889, 94903, 94907, 94933, 94949, 94951, 94961, 94993, 94999, 95003, 95009, 95021, 95027, 95063, 95071, 95083, 95087, 95089, 95093, 95101, 95107, 95111, 95131, 95143, 95153, 95177, 95189, 95191, 95203, 95213, 95219, 95231, 95233, 95239, 95257, 95261, 95267, 95273, 95279, 95287, 95311, 95317, 95327, 95339, 95369, 95383, 95393, 95401, 95413, 95419, 95429, 95441, 95443, 95461, 95467, 95471, 95479, 95483, 95507, 95527, 95531, 95539, 95549, 95561, 95569, 95581, 95597, 95603, 95617, 95621, 95629, 95633, 95651, 95701, 95707, 95713, 95717, 95723, 95731, 95737, 95747, 95773, 95783, 95789, 95791, 95801, 95803, 95813, 95819, 95857, 95869, 95873, 95881, 95891, 95911, 95917, 95923, 95929, 95947, 95957, 95959, 95971, 95987, 95989, 96001, 96013, 96017, 96043, 96053, 96059, 96079, 96097, 96137, 96149, 96157, 96167, 96179, 96181, 96199, 96211, 96221, 96223, 96233, 96259, 96263, 96269, 96281, 96289, 96293, 96323, 96329, 96331, 96337, 96353, 96377, 96401, 96419, 96431, 96443, 96451, 96457, 96461, 96469, 96479, 96487, 96493, 96497, 96517, 96527, 96553, 96557, 96581, 96587, 96589, 96601, 96643, 96661, 96667, 96671, 96697, 96703, 96731, 96737, 96739, 96749, 96757, 96763, 96769, 96779, 96787, 96797, 96799, 96821, 96823, 96827, 96847, 96851, 96857, 96893, 96907, 96911, 96931, 96953, 96959, 96973, 96979, 96989, 96997, 97001, 97003, 97007, 97021, 97039, 97073, 97081, 97103, 97117, 97127, 97151, 97157, 97159, 97169, 97171, 97177, 97187, 97213, 97231, 97241, 97259, 97283, 97301, 97303, 97327, 97367, 97369, 97373, 97379, 97381, 97387, 97397, 97423, 97429, 97441, 97453, 97459, 97463, 97499, 97501, 97511, 97523, 97547, 97549, 97553, 97561, 97571, 97577, 97579, 97583, 97607, 97609, 97613, 97649, 97651, 97673, 97687, 97711, 97729, 97771, 97777, 97787, 97789, 97813, 97829, 97841, 97843, 97847, 97849, 97859, 97861, 97871, 97879, 97883, 97919, 97927, 97931, 97943, 97961, 97967, 97973, 97987, 98009, 98011, 98017, 98041, 98047, 98057, 98081, 98101, 98123, 98129, 98143, 98179, 98207, 98213, 98221, 98227, 98251, 98257, 98269, 98297, 98299, 98317, 98321, 98323, 98327, 98347, 98369, 98377, 98387, 98389, 98407, 98411, 98419, 98429, 98443, 98453, 98459, 98467, 98473, 98479, 98491, 98507, 98519, 98533, 98543, 98561, 98563, 98573, 98597, 98621, 98627, 98639, 98641, 98663, 98669, 98689, 98711, 98713, 98717, 98729, 98731, 98737, 98773, 98779, 98801, 98807, 98809, 98837, 98849, 98867, 98869, 98873, 98887, 98893, 98897, 98899, 98909, 98911, 98927, 98929, 98939, 98947, 98953, 98963, 98981, 98993, 98999, 99013, 99017, 99023, 99041, 99053, 99079, 99083, 99089, 99103, 99109, 99119, 99131, 99133, 99137, 99139, 99149, 99173, 99181, 99191, 99223, 99233, 99241, 99251, 99257, 99259, 99277, 99289, 99317, 99347, 99349, 99367, 99371, 99377, 99391, 99397, 99401, 99409, 99431, 99439, 99469, 99487, 99497, 99523, 99527, 99529, 99551, 99559, 99563, 99571, 99577, 99581, 99607, 99611, 99623, 99643, 99661, 99667, 99679, 99689, 99707, 99709, 99713, 99719, 99721, 99733, 99761, 99767, 99787, 99793, 99809, 99817, 99823, 99829, 99833, 99839, 99859, 99871, 99877, 99881, 99901, 99907, 99923, 99929, 99961, 99971, 99989, 99991
                </div>
            </section>

        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Theme Control ---
            const themeToggle = document.getElementById('theme-toggle');
            const docElement = document.documentElement;

            const applyTheme = (theme) => {
                docElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                themeToggle.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            };

            const toggleTheme = () => {
                const currentTheme = docElement.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                applyTheme(newTheme);
            };

            themeToggle.addEventListener('click', toggleTheme);

            // Initial theme setup
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme) {
                applyTheme(savedTheme);
            } else if (prefersDark) {
                applyTheme('dark');
            } else {
                applyTheme('light'); // Default
            }

            // --- Core Calculation Functions (BigInt) ---
            const ZERO = 0n, ONE = 1n, TWO = 2n;

            /**
             * æ‹¡å¼µãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰ã®äº’é™¤æ³• (BigIntå¯¾å¿œç‰ˆ)ã€‚
             * ax + by = gcd(a, b) ã¨ãªã‚‹ [x, y, d] ã‚’è¿”ã™ã€‚
             * withStepsãŒtrueã®å ´åˆã€4ç•ªç›®ã®è¿”ã‚Šå€¤ã¨ã—ã¦è¨ˆç®—éç¨‹ã®æ–‡å­—åˆ—ã‚’è¿”ã™ã€‚
             */
            function extGCD_BigInt(a, b, withSteps = false) {
                if (!withSteps) {
                    if (b === ZERO) return [1n, 0n, a];
                    const [s, t, d] = extGCD_BigInt(b, a % b);
                    return [t, s - (a / b) * t, d];
                }

                let steps = `ax + by = gcd(a, b) ã‚’è§£ãã¾ã™ (a=${a}, b=${b})\n\n`;
                let r_prev = a, r_curr = b;
                let s_prev = 1n, s_curr = 0n;
                let t_prev = 0n, t_curr = 1n;

                steps += `åˆæœŸçŠ¶æ…‹ (i=0, 1):\n`;
                steps += ` r_0 = ${r_prev}, s_0 = ${s_prev}, t_0 = ${t_prev}\n`;
                steps += ` r_1 = ${r_curr}, s_1 = ${s_curr}, t_1 = ${t_curr}\n\n`;
                
                let i = 1;
                while (r_curr !== 0n) {
                    i++;
                    const q = r_prev / r_curr;
                    const r_next = r_prev - q * r_curr;
                    const s_next = s_prev - q * s_curr;
                    const t_next = t_prev - q * t_curr;

                    steps += `ã‚¹ãƒ†ãƒƒãƒ— ${i-1} (i=${i}):\n`;
                    steps += ` q_${i-1} = floor(r_${i-2} / r_${i-1}) = floor(${r_prev} / ${r_curr}) = ${q}\n`;
                    steps += ` r_${i} = r_${i-2} - q * r_${i-1} = ${r_prev} - ${q} * ${r_curr} = ${r_next}\n`;
                    steps += ` s_${i} = s_${i-2} - q * s_${i-1} = ${s_prev} - ${q} * ${s_curr} = ${s_next}\n`;
                    steps += ` t_${i} = t_${i-2} - q * t_${i-1} = ${t_prev} - ${q} * ${t_curr} = ${t_next}\n\n`;

                    r_prev = r_curr; r_curr = r_next;
                    s_prev = s_curr; s_curr = s_next;
                    t_prev = t_curr; t_curr = t_next;
                }

                steps += `r_${i} = 0 ã¨ãªã£ãŸã®ã§è¨ˆç®—çµ‚äº†ã€‚\n`;
                steps += `ä¸€ã¤å‰ã®ã‚¹ãƒ†ãƒƒãƒ— (i=${i-1}) ã®çµæœãŒè§£ã¨ãªã‚Šã¾ã™ã€‚\n`;

                return [s_prev, t_prev, r_prev, steps];
            }

            /**
             * ç¹°ã‚Šè¿”ã—äºŒä¹—æ³• (a^n mod p) (BigIntå¯¾å¿œç‰ˆ)ã€‚
             * withStepsãŒtrueã®å ´åˆã€2ç•ªç›®ã®è¿”ã‚Šå€¤ã¨ã—ã¦è¨ˆç®—éç¨‹ã®æ–‡å­—åˆ—ã‚’è¿”ã™ã€‚
             */
            function exp_mod(a, n, p, withSteps = false) {
                let res = 1n;
                let base = a % p;
                let exp = n;
                let steps = `a^n mod p ã‚’è¨ˆç®—ã—ã¾ã™ (a=${a}, n=${n}, p=${p})\n\n`;
                steps += `n ã®2é€²æ•°è¡¨ç¾: ${n.toString(2)}\n\n`;
                steps += `åˆæœŸå€¤: result = 1, base = ${base}\n\n`;

                let i = 0;
                while (exp > 0n) {
                    steps += `ã‚¹ãƒ†ãƒƒãƒ— ${i}:\n`;
                    steps += `  æŒ‡æ•° = ${exp} (2é€²æ•°: ${exp.toString(2)})\n`;
                    if (exp % TWO === ONE) {
                        res = (res * base) % p;
                        steps += `  æŒ‡æ•°ãŒå¥‡æ•°ãªã®ã§ã€result = (result * base) mod p = ${res}\n`;
                    } else {
                        steps += `  æŒ‡æ•°ãŒå¶æ•°ãªã®ã§ã€resultã¯å¤‰æ›´ãªã—\n`;
                    }
                    base = (base * base) % p;
                    exp = exp / TWO;
                    steps += `  æ¬¡ã®æº–å‚™: base = (base * base) mod p = ${base}\n`;
                    steps += `  æ¬¡ã®æº–å‚™: æŒ‡æ•° = floor(æŒ‡æ•° / 2) = ${exp}\n\n`;
                    i++;
                }
                steps += `è¨ˆç®—çµ‚äº†ã€‚æœ€çµ‚çµæœ: ${res}\n`;
                return withSteps ? [res, steps] : res;
            }

            // --- String Conversion Functions ---

            function stringToCodePoints(str) {
                const codePoints = [];
                for (let i = 0; i < str.length; i++) {
                    const code = str.codePointAt(i);
                    if (code > 0xFFFF) { // ã‚µãƒ­ã‚²ãƒ¼ãƒˆãƒšã‚¢ã®å ´åˆ
                        i++;
                    }
                    codePoints.push(BigInt(code));
                }
                return codePoints;
            }

            function codePointsToString(arr) {
                return String.fromCodePoint(...arr.map(n => Number(n)));
            }

            // --- UI Control ---

            const navLinks = document.querySelectorAll('#nav-menu a');
            const sections = document.querySelectorAll('main section');

            function showSection(sectionId) {
                sections.forEach(section => {
                    section.classList.remove('active');
                });
                navLinks.forEach(link => {
                    link.classList.remove('active');
                });

                const activeSection = document.getElementById(sectionId || 'menu');
                const activeLink = document.querySelector(`nav a[data-section="${sectionId}"]`);
                if (activeSection) activeSection.classList.add('active');
                if (activeLink) { activeLink.classList.add('active'); }
                else { document.querySelector('nav a[data-section="menu"]').classList.add('active'); }
            }

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = e.target.getAttribute('data-section');
                    showSection(sectionId);
                });
            });

            // --- Event Handlers for each section ---

            // æ‹¡å¼µãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰äº’é™¤æ³•
            document.getElementById('run-extgcd').addEventListener('click', () => {
                try {
                    const a = BigInt(document.getElementById('extgcd-a').value);
                    const b = BigInt(document.getElementById('extgcd-b').value);
                    const [x, y, d, steps] = extGCD_BigInt(a, b, true);
                    const resultDiv = document.getElementById('extgcd-result');
                    resultDiv.textContent = `--- è¨ˆç®—éç¨‹ ---\n${steps}\n` +
                        `--- è¨ˆç®—çµæœ ---\n` +
                        `gcd(a, b) = d: ${d}\n` +
                        `è§£ x: ${x}\n` +
                        `è§£ y: ${y}\n\n` +
                        `--- æ¤œç®— ---\nax + by = d\n` +
                        `${a} * ${x} + ${b} * ${y} = ${a * x + b * y}`;
                } catch (e) {
                    document.getElementById('extgcd-result').textContent = 'ã‚¨ãƒ©ãƒ¼: æœ‰åŠ¹ãªæ•´æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                }
            });

            // ç¹°ã‚Šè¿”ã—äºŒä¹—æ³•
            document.getElementById('run-expmod').addEventListener('click', () => {
                try {
                    const a = BigInt(document.getElementById('expmod-a').value);
                    const n = BigInt(document.getElementById('expmod-n').value);
                    const p = BigInt(document.getElementById('expmod-p').value);
                    const [result, steps] = exp_mod(a, n, p, true);
                    document.getElementById('expmod-result').textContent = `--- è¨ˆç®—éç¨‹ ---\n${steps}\n` +
                        `--- è¨ˆç®—çµæœ ---\n` +
                        `${a}^${n} mod ${p} = ${result}\n`;
                } catch (e) {
                    document.getElementById('expmod-result').textContent = 'ã‚¨ãƒ©ãƒ¼: æœ‰åŠ¹ãªæ•´æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                }
            });

            // ã‚­ãƒ¼ãƒšã‚¢ä½œæˆ
            document.getElementById('set-random-primes').addEventListener('click', () => {
                try {
                    const primeListText = document.querySelector('#prime-list .result').textContent;
                    const primes = primeListText.split(/,\s*/).filter(s => s.trim() !== '');

                    if (primes.length < 2) {
                        alert('ç´ æ•°ãƒªã‚¹ãƒˆã‹ã‚‰2ã¤ä»¥ä¸Šã®ç´ æ•°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                        return;
                    }

                    let index1 = Math.floor(Math.random() * primes.length);
                    let index2;
                    do {
                        index2 = Math.floor(Math.random() * primes.length);
                    } while (index1 === index2);

                    document.getElementById('keygen-p').value = primes[index1];
                    document.getElementById('keygen-q').value = primes[index2];

                } catch (e) {
                    alert('ãƒ©ãƒ³ãƒ€ãƒ ãªç´ æ•°ã®ã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
                }
            });

            document.getElementById('run-keygen').addEventListener('click', () => {
                const resultDiv = document.getElementById('keygen-result');
                try {
                    const p = BigInt(document.getElementById('keygen-p').value);
                    const q = BigInt(document.getElementById('keygen-q').value);
                    const e = BigInt(document.getElementById('keygen-e').value);

                    const n = p * q;
                    const phi = (p - ONE) * (q - ONE);

                    const [x, y, gcd, steps] = extGCD_BigInt(e, phi, true);

                    if (gcd !== ONE) {
                        resultDiv.textContent = `ã‚¨ãƒ©ãƒ¼: e (${e}) ã¨ (p-1)(q-1) (${phi}) ã¯äº’ã„ã«ç´ ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚\ngcdã¯ ${gcd} ã§ã™ã€‚åˆ¥ã®eã‚’é¸ã‚“ã§ãã ã•ã„ã€‚`;
                        return;
                    }

                    // ç§˜å¯†æŒ‡æ•° d ã‚’è¨ˆç®— (d*e â‰¡ 1 (mod phi))
                    // dã¯xã‚’phiã§å‰²ã£ãŸæ­£ã®å‰°ä½™
                    const d = (x % phi + phi) % phi;

                    resultDiv.textContent = `--- è¨ˆç®—éç¨‹ ---\n` +
                        `1. n ã¨ Ï†(n) ã®è¨ˆç®—:\n` +
                        `   n = p * q = ${n}\n` +
                        `   Ï†(n) = (p-1)*(q-1) = ${phi}\n\n` +
                        `2. ç§˜å¯†éµ d ã®è¨ˆç®— (e*d â‰¡ 1 mod Ï†(n)):\n` +
                        `   æ‹¡å¼µãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰äº’é™¤æ³•ã§ e*x + Ï†(n)*y = gcd(e, Ï†(n)) ã‚’è§£ãã¾ã™ã€‚\n` +
                        `${steps}` +
                        `   d = x mod Ï†(n) = (${x} % ${phi} + ${phi}) % ${phi} = ${d}\n\n` +
                        `--- ç”Ÿæˆã•ã‚ŒãŸã‚­ãƒ¼ãƒšã‚¢ ---\n` +
                        `å…¬é–‹éµ (èª°ã«ã§ã‚‚å…¬é–‹ã—ã¦OK):\n` +
                        `   {e, n} = {${e}, ${n}}\n\n` +
                        `ç§˜å¯†éµ (çµ¶å¯¾ã«ç§˜å¯†ã«ã—ã¦ãã ã•ã„):\n` +
                        `   {d, n} = {${d}, ${n}}`;
                    const copyText = `ç§ã®å…¬é–‹ã‚­ãƒ¼ã€€æ³•nã¨å…¬é–‹æŒ‡æ•°ã§ã™ã€‚\næ³•n: ${n.toString()}\nå…¬é–‹æŒ‡æ•°e: ${e.toString()}`;
                    navigator.clipboard.writeText(copyText).then(() => {
                        resultDiv.textContent += '\n\n--------------------\nå…¬é–‹éµæƒ…å ±ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
                    }).catch(err => {
                        console.error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ', err);
                        resultDiv.textContent += '\n\n--------------------\nã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚';
                    });

                    // æ¬¡ã®ç”»é¢ã«å€¤ã‚’è‡ªå‹•å…¥åŠ›
                    document.getElementById('encrypt-e').value = e.toString();
                    document.getElementById('encrypt-n').value = n.toString();
                    document.getElementById('decrypt-d').value = d.toString();
                    document.getElementById('decrypt-n').value = n.toString();

                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆãƒ»å¾©å·ç”»é¢ã«ã€å®Ÿè¡Œè€…ã®ã‚­ãƒ¼æƒ…å ±ã‚’è‡ªå‹•å…¥åŠ›
                    // é€ä¿¡è€…(A) = å®Ÿè¡Œè€…ã¨ã—ã¦è¨­å®š
                    document.getElementById('create-p-a').value = p.toString();
                    document.getElementById('create-q-a').value = q.toString();
                    document.getElementById('create-e-a').value = e.toString();
                    // å—ä¿¡è€…(B)ã®æƒ…å ±ã¯ç©ºæ¬„ã«ã—ã€ç›¸æ‰‹ã®å…¬é–‹éµã‚’æ‰‹å‹•ã§å…¥åŠ›ã™ã‚‹ã‚ˆã†ã«ä¿ƒã™
                    document.getElementById('create-n-b').value = '';
                    document.getElementById('create-e-b').value = '';

                    // å—ä¿¡è€…(B) = å®Ÿè¡Œè€…ã¨ã—ã¦è¨­å®š
                    document.getElementById('read-p-b').value = p.toString();
                    document.getElementById('read-q-b').value = q.toString();
                    document.getElementById('read-e-b').value = e.toString();
                    // é€ä¿¡è€…(A)ã®æƒ…å ±ã¯ç©ºæ¬„ã«ã—ã€ç›¸æ‰‹ã®å…¬é–‹éµã‚’æ‰‹å‹•ã§å…¥åŠ›ã™ã‚‹ã‚ˆã†ã«ä¿ƒã™
                    document.getElementById('read-n-a').value = '';
                    document.getElementById('read-e-a').value = '';

                } catch (e) {
                    resultDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: æœ‰åŠ¹ãªç´ æ•°ã¨æ•´æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                }
            });

            // æš—å·åŒ–
            document.getElementById('run-encrypt').addEventListener('click', () => {
                const resultDiv = document.getElementById('encrypt-result');
                try {
                    const m = BigInt(document.getElementById('encrypt-m').value);
                    const e = BigInt(document.getElementById('encrypt-e').value);
                    const n = BigInt(document.getElementById('encrypt-n').value);

                    if (m >= n) {
                        resultDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: å¹³æ–‡Mã¯æ³•nã‚ˆã‚Šå°ã•ã„å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚';
                        return;
                    }

                    const [c, steps] = exp_mod(m, e, n, true);
                    resultDiv.textContent = `--- è¨ˆç®—éç¨‹ (C = M^e mod n) ---\n` +
                        `${steps}\n` +
                        `--- æš—å·åŒ–çµæœ ---\n` +
                        `æš—å·æ–‡ C = ${c}\n\n` +
                        `ã“ã®æš—å·æ–‡ã‚’ã€Œå¾©å·ã€ç”»é¢ã«ã‚³ãƒ”ãƒ¼ã—ã¦ã€å…ƒã®å¹³æ–‡ã«æˆ»ã›ã‚‹ã‹è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚`
                        ;
                    
                    // å¾©å·ç”»é¢ã«æš—å·æ–‡ã‚’è‡ªå‹•å…¥åŠ›
                    document.getElementById('decrypt-c').value = c.toString();

                } catch (e) {
                    resultDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: æœ‰åŠ¹ãªæ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                }
            });

            // å¾©å·
            document.getElementById('run-decrypt').addEventListener('click', () => {
                const resultDiv = document.getElementById('decrypt-result');
                try {
                    const c = BigInt(document.getElementById('decrypt-c').value);
                    const d = BigInt(document.getElementById('decrypt-d').value);
                    const n = BigInt(document.getElementById('decrypt-n').value);

                    const [m, steps] = exp_mod(c, d, n, true);
                    resultDiv.textContent = `--- è¨ˆç®—éç¨‹ (M = C^d mod n) ---\n` +
                        `${steps}\n` +
                        `--- å¾©å·çµæœ ---\n` +
                        `å¹³æ–‡ M = ${m}\n\nå…ƒã®å¹³æ–‡ã«æˆ»ã‚Šã¾ã—ãŸï¼`;
                } catch (e) {
                    resultDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: æœ‰åŠ¹ãªæ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                }
            });

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆï¼ˆç½²åã¨æš—å·åŒ–ï¼‰
            document.getElementById('run-create-message').addEventListener('click', async () => {
                const resultDiv = document.getElementById('create-message-result');
                const spinner = document.getElementById('create-spinner');
                resultDiv.textContent = '';
                spinner.style.display = 'block';

                // éåŒæœŸå‡¦ç†ã§UIã®ãƒ•ãƒªãƒ¼ã‚ºã‚’é˜²ã
                await new Promise(resolve => setTimeout(resolve, 10));

                try {
                    // é€ä¿¡è€…Aã®ã‚­ãƒ¼
                    const p_a = BigInt(document.getElementById('create-p-a').value);
                    const q_a = BigInt(document.getElementById('create-q-a').value);
                    const e_a = BigInt(document.getElementById('create-e-a').value);
                    const n_a = p_a * q_a;
                    const phi_a = (p_a - ONE) * (q_a - ONE);
                    const [x_a, , gcd_a] = extGCD_BigInt(e_a, phi_a, false);
                    if (gcd_a !== ONE) throw new Error(`é€ä¿¡è€…Aã®e (${e_a}) ã¨ Ï†(n) (${phi_a}) ãŒäº’ã„ã«ç´ ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                    const d_a = (x_a % phi_a + phi_a) % phi_a;

                    // å—ä¿¡è€…Bã®å…¬é–‹éµ
                    const n_b = BigInt(document.getElementById('create-n-b').value);
                    const e_b = BigInt(document.getElementById('create-e-b').value);

                    // å¹³æ–‡
                    const message = document.getElementById('create-message-text').value;
                    const codePoints = stringToCodePoints(message);

                    // å„æ–‡å­—ã®ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒnã‚ˆã‚Šå°ã•ã„ã‹ãƒã‚§ãƒƒã‚¯
                    const maxCodePoint = codePoints.reduce((max, current) => (current > max ? current : max), 0n);
                    if (maxCodePoint >= n_a || maxCodePoint >= n_b) {
                        throw new Error(`ã‚¨ãƒ©ãƒ¼: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ (${maxCodePoint}) ãŒã€æ³•n (${n_a} ã¾ãŸã¯ ${n_b}) ä»¥ä¸Šã§ã™ã€‚ã‚ˆã‚Šå¤§ããªç´ æ•°ã§ã‚­ãƒ¼ã‚’å†ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`);
                    }

                    let stepsLog = '';
                    const encryptedBlocks = [];
                    for (const [index, m] of codePoints.entries()) {
                        const withSteps = (index === 0);

                        // 1. é€ä¿¡è€…Aã®ç§˜å¯†éµã§ç½²å
                        const signResult = exp_mod(m, d_a, n_a, withSteps);
                        const signed = withSteps ? signResult[0] : signResult;

                        // 2. å—ä¿¡è€…Bã®å…¬é–‹éµã§æš—å·åŒ–
                        const encryptResult = exp_mod(signed, e_b, n_b, withSteps);
                        const encrypted = withSteps ? encryptResult[0] : encryptResult;
                        encryptedBlocks.push(encrypted.toString());

                        if (withSteps) {
                            const signSteps = signResult[1];
                            const encryptSteps = encryptResult[1];
                            stepsLog = `--- è¨ˆç®—éç¨‹ (æœ€åˆã®1æ–‡å­— '${String.fromCodePoint(Number(m))}' (ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: ${m})) ---\n\n` +
                                       `1. é€ä¿¡è€…Aã®ç§˜å¯†éµã§ç½²å (S = M^d_A mod n_A):\n${signSteps}\n` +
                                       `   ç½²åãƒ‡ãƒ¼ã‚¿ S = ${signed}\n\n` +
                                       `2. å—ä¿¡è€…Bã®å…¬é–‹éµã§æš—å·åŒ– (C = S^e_B mod n_B):\n${encryptSteps}\n` +
                                       `   æœ€çµ‚çš„ãªæš—å·æ–‡ C = ${encrypted}\n\n`;
                        }
                    }

                    const finalCiphertext = encryptedBlocks.join(',');
                    resultDiv.textContent = (stepsLog ? stepsLog : '') +
                        `--- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆå®Œäº† ---\n` +
                        `ç”Ÿæˆã•ã‚ŒãŸæš—å·æ–‡ï¼ˆã“ã‚Œã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å—ä¿¡è€…ã«æ¸¡ã—ã¾ã™ï¼‰:\n${finalCiphertext}\n\n` +
                        `--------------------\n` +
                        `ç½²åæ¤œè¨¼ã«å¿…è¦ãªæƒ…å ±ï¼ˆé€ä¿¡è€…Aã®n,eã¨æš—å·æ–‡ï¼‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã™...`;

                    const copyText = `${n_a.toString()},${e_a.toString()}\n${finalCiphertext}`;
                    navigator.clipboard.writeText(copyText).then(() => {
                        resultDiv.textContent += '\nã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
                    }).catch(err => {
                        console.error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ', err);
                        resultDiv.textContent += '\nã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚';
                    });

                    document.getElementById('read-ciphertext').value = finalCiphertext;

                } catch (e) {
                    resultDiv.textContent = `ã‚¨ãƒ©ãƒ¼: ${e.message}`;
                } finally {
                    spinner.style.display = 'none';
                }
            });

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¾©å·ï¼ˆå¾©å·ã¨ç½²åæ¤œè¨¼ï¼‰
            document.getElementById('run-read-message').addEventListener('click', async () => {
                const resultDiv = document.getElementById('read-message-result');
                const spinner = document.getElementById('read-spinner');
                resultDiv.textContent = '';
                spinner.style.display = 'block';

                await new Promise(resolve => setTimeout(resolve, 10));

                try {
                    // å—ä¿¡è€…Bã®ã‚­ãƒ¼
                    const p_b = BigInt(document.getElementById('read-p-b').value);
                    const q_b = BigInt(document.getElementById('read-q-b').value);
                    const e_b = BigInt(document.getElementById('read-e-b').value);
                    const n_b = p_b * q_b;
                    const phi_b = (p_b - ONE) * (q_b - ONE);
                    const [x_b, , gcd_b] = extGCD_BigInt(e_b, phi_b, false);
                    if (gcd_b !== ONE) throw new Error(`å—ä¿¡è€…Bã®e (${e_b}) ã¨ Ï†(n) (${phi_b}) ãŒäº’ã„ã«ç´ ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                    const d_b = (x_b % phi_b + phi_b) % phi_b;

                    // é€ä¿¡è€…Aã®å…¬é–‹éµ
                    const n_a = BigInt(document.getElementById('read-n-a').value);
                    const e_a = BigInt(document.getElementById('read-e-a').value);

                    // æš—å·æ–‡
                    const ciphertext = document.getElementById('read-ciphertext').value;
                    if (!ciphertext) throw new Error('æš—å·æ–‡ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                    const encryptedBlocks = ciphertext.split(',').map(s => BigInt(s.trim()));

                    let stepsLog = '';
                    const decryptedCodePoints = [];
                    for (const [index, c] of encryptedBlocks.entries()) {
                        const withSteps = (index === 0);

                        // 1. å—ä¿¡è€…Bã®ç§˜å¯†éµã§å¾©å·
                        const decryptResult = exp_mod(c, d_b, n_b, withSteps);
                        const decrypted = withSteps ? decryptResult[0] : decryptResult;

                        // 2. é€ä¿¡è€…Aã®å…¬é–‹éµã§ç½²åæ¤œè¨¼
                        const verifyResult = exp_mod(decrypted, e_a, n_a, withSteps);
                        const verified = withSteps ? verifyResult[0] : verifyResult;

                        decryptedCodePoints.push(verified);

                        if (withSteps) {
                            const decryptSteps = decryptResult[1];
                            const verifySteps = verifyResult[1];
                            stepsLog = `--- è¨ˆç®—éç¨‹ (æœ€åˆã®1ãƒ–ãƒ­ãƒƒã‚¯ '${c}') ---\n\n` +
                                       `1. å—ä¿¡è€…Bã®ç§˜å¯†éµã§å¾©å· (S = C^d_B mod n_B):\n${decryptSteps}\n` +
                                       `   å¾©å·ã•ã‚ŒãŸç½²åãƒ‡ãƒ¼ã‚¿ S = ${decrypted}\n\n` +
                                       `2. é€ä¿¡è€…Aã®å…¬é–‹éµã§ç½²åæ¤œè¨¼ (M = S^e_A mod n_A):\n${verifySteps}\n` +
                                       `   å…ƒã®æ–‡å­—ã®ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ³ãƒˆ M = ${verified}\n\n`;
                        }
                    }

                    const originalMessage = codePointsToString(decryptedCodePoints);

                    resultDiv.textContent = (stepsLog ? stepsLog : '') +
                        `--- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¾©å·å®Œäº† ---\n` +
                        `å¾©å·ãƒ»ç½²åæ¤œè¨¼ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:\n\n${originalMessage}`;

                } catch (e) {
                    resultDiv.textContent = `ã‚¨ãƒ©ãƒ¼: ${e.message}`;
                } finally {
                    spinner.style.display = 'none';
                }
            });

            // åˆæœŸè¡¨ç¤º
            showSection('menu');
        });
    </script>

</body>
</html>